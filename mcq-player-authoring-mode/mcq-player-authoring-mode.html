<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../paper-card/paper-card.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">  
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="simple-mde-import.html">
<link rel="import" href="highlightjs-import.html">
<link rel="import" href="showdown-import.html">
<link rel="import" href="jquery-import.html">

<dom-module id="mcq-player-authoring-mode">
  <template>
    <link rel="stylesheet" href="../../bower_components/highlightjs/styles/github.css">
    <link rel="stylesheet" href="../../bower_components/simplemde/dist/simplemde.min.css">
    <link rel="stylesheet" href="../../bower_components/font-awesome/css/font-awesome.min.css">
    <style>
      @import url('https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800');
      :host {
        display: block;
        height: 100%;
        max-height: 100%;
      }

      .editable {
        min-height: 50px;
        height: 100%;
        width: 100%;
        background: whitesmoke;
      }

      .CodeMirror, .cm-s-paper, CodeMirror-wrap {
        height: 100% !important;
        font-family: 'Open Sans', sans-serif !important;
      }

      .editor-card-element {
        width: 100%;
        height: 100%;
        max-height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .card-content {
        flex: 1 1 auto;
        overflow: auto;
      }

      .card-header{
        background-color: #DD2C00;
        height: 150px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
      }
      
      .card-header-content {
        text-align: center;
      }

      .action-buttons {
        flex: 0 1 auto;
        text-align: right;
        padding: 15px;
      }

      paper-button.publish-button {
        background: #DD2C00;
        color: #ffffff;
      }

      paper-radio-button {
        padding-top: 20px;
      }

      .CodeMirror {
        border-color: transparent !important;
      }
      .editor-preview {
        background: rgb(255, 255, 255) !important;
      }
    </style>
    <paper-card class="editor-card-element">
      <div class="card-content">
        <textarea id="editor"></textarea>
      </div>
      <div class="card-actions action-buttons">
        <paper-icon-button icon="visibility" on-click="previewQuestion"></paper-icon-button> 
        <paper-button raised on-click="publishQuestion" class="publish-button">Publish</paper-button>
      </div>
    </paper-card>
  </template>

  <script>
    class McqPlayerAuthoringMode extends Polymer.Element {
      static get is() { 
        return 'mcq-player-authoring-mode'; 
      }
      
      static get properties() {
        return {
          simplemde: {
            type: Object,
          },
          mdQuestion: {
            type: String,
            notify: true,
            value: ''
          },
          value: {
            type: String,
            notify: true
          }
        }
      }
      
      constructor() {
        super();
        this.convertor = new showdown.Converter();
      }

      // Not a part of MCQ Player should be imported as external script. 
      guid() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        };
        
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
      }

      connectedCallback() {
        super.connectedCallback();
        this._initialize();
      }

      //TODO: Convert boilerplate as a private property in properties method.
      _initialize() {
        const boilerplate = this.value || `# Question \n\n# Instructions \n\n# Option-1 \n\n# Option-2 \n\n# Option-3 \n\n# Option-4 \n\n# Answer \n\n`;
        // Options for SimpleMDE
        const options = {
          element: this.$.editor,
          renderingConfig: {
            codeSyntaxHighlighting: true
          },
          shortcuts: {
            "togglePreview": "Ctrl-Alt-P"
          },
          status: false,
          toolbar: false,
          placeholder: boilerplate,
          previewRender: this._renderPreview.bind(this)
        };
        const simplemde = new SimpleMDE(options);
        this.set('simplemde', simplemde);
        simplemde.codemirror.on('changes', this._handleChanges.bind(this));
        this.set('mdQuestion', boilerplate);
      }

      _handleChanges() {
        this.set('mdQuestion', this.simplemde.value());
        const changedMdQuestion = {
          detail: {
            mdQuestion: this.mdQuestion
          }
        };
        this.dispatchEvent(new CustomEvent('questionChanged', changedMdQuestion));
      }

      // Used to toggle between the preview and the authoring mode.
      previewQuestion() {
        this.simplemde.togglePreview();
      }

      publishQuestion() {
        const htmlTemplate = this.convertor.makeHtml(this.mdQuestion);

        const htmlElement = document.createElement('div');
        htmlElement.innerHTML = htmlTemplate;

        // Every component of the MCQ Player is stored as an Header.
        const h1Elements = jQuery(htmlElement).find('h1').toArray();
        const mcqQuestion = {};
        
        // The Populate MCQQuestion Object
        h1Elements.forEach((h1Element, index) => {
          let siblings;
          const currentElement = $(h1Element);
          // Id of the current element.
          const currentElementName = currentElement.attr('id');
          // Assign a new Object to the currentElementName
          mcqQuestion[currentElementName] = { };
          // Assign an uniqueId to every element of the Multiple Choice Question
          mcqQuestion[currentElementName].id = this.guid();
          // If the element is not the last element then choose all the elements between
          // the currentElement and the nextElement.
          // If the element is the last element in the series then choose all the elements
          // next to it.
          if(index != h1Elements.length) {
            // Assigns the nextHeaderElement.
            const nextHeaderElement = jQuery(h1Elements[index + 1])[0];
            // Collect all the elements between the currentElement and the nextHeaderElement.
            const siblingElements = currentElement.nextUntil(nextHeaderElement).toArray();
            // Store the rendered HTML structure for the current element.
            mcqQuestion[currentElementName].template = siblingElements.map((element) => element.outerHTML).join();
            // Store the content as a readable text.
            mcqQuestion[currentElementName].content = siblingElements.map((element) => element.innerText).join(' ');
          } else {
            const siblingElements = currentElement.nextAll().toArray();
            // Since this is the last element choose all the elements after it.
            mcqQuestion[currentElementName].template = siblingElements.map((element) => element.outerHTML).join();
            // Store the content as readable string
            mcqQuestion[currentElementName].content = siblingElements.map((element) => element.innerText).join(' ');
          }
        });

        // Fetches the text of the answer from the McqQuestion 
        const answerText = mcqQuestion.answer.content.trim().toLowerCase().replace(/-/g, '');
        // Assigns the answerId property with the id of the actual answer.
        mcqQuestion.answer.answerId = mcqQuestion[answerText].id;
  
        // Create a new object containing both the raw version and the processed version of 
        // the Multiple Choice Question
        const publishedQuestion = {
          detail: {
            mdQuestion: this.mdQuestion,
            mcqQuestion: mcqQuestion
          }
        };

        // Once the question is created a `questionPublished` event is dispatched.
        this.dispatchEvent(new CustomEvent('questionPublished', publishedQuestion));
      }

      _renderPreview(mdText) {
        const htmlTemplate = this.convertor.makeHtml(mdText);
        const htmlElement = document.createElement('div');
        htmlElement.innerHTML = htmlTemplate;
        $(htmlElement).find('#answer').next().remove();
        $(htmlElement).find('#answer').remove();
        
        const h1Elements = $(htmlElement).find('h1').toArray();
        const contents = h1Elements.map((h1Element, index) => {
          let siblings;
          if(index != h1Elements.length) {
            siblings = $(h1Element).nextUntil($(h1Elements[index + 1])[0]);
          } else {
            siblings = $(h1Element).nextAll();
          }
          return siblings;
        });
        const previewWrapper = document.createElement('div');
        previewWrapper.innerHTML = `<h1>Question</h1>
                                    <div id="question"></div>
                                    <h1>Instructions</h1>
                                    <div id="instructions"></div>
                                    <h1>Options</h1>
                                    <paper-radio-group id="options">
                                    </paper-radio-group>`;
        $($(previewWrapper).find('#question')[0]).append(contents[0]);
        $($(previewWrapper).find('#instructions')[0]).append(contents[1]);
        const optionTemplate = `<paper-radio-button></paper-radio-button><div class="option"></div>`;
          const options = contents.splice(2, contents.length - 2).map((option) => {
            const optionElement = document.createElement('div');
            optionElement.innerHTML = optionTemplate;
            const radioButton = $($(optionElement).find('paper-radio-button')[0]); 
            const radioButtonContent = $($(optionElement).find('.option')[0]).html(option);
            radioButtonContent.insertAfter(radioButton);
            return optionElement;
        });
        $($(previewWrapper).find('#options')[0]).append(options);
        return previewWrapper.innerHTML; 
      }
    }
    window.customElements.define(McqPlayerAuthoringMode.is, McqPlayerAuthoringMode);
  </script>
</dom-module>